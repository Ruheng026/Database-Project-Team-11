-- public

SELECT StuNationality, COUNT(*) AS TotalStudentsByNationality
FROM STUDENT
GROUP BY StuNationality
ORDER BY TotalStudentsByNationality DESC, StuNationality
LIMIT 10;

SELECT SchCounty, COUNT(DISTINCT School_ID) AS SchoolCount
FROM SCHOOL
GROUP BY SchCounty
ORDER BY SchoolCount DESC, SchCounty;

-- student page

SELECT StuName, StuNationality, StuType, StuDegree, StuSex, StuPhone, StuUniversity, StuEmail
FROM STUDENT
WHERE ICL_ID = 'B10705039';

SELECT DISTINCT Semester
FROM STUDENT_COURSE
WHERE ICL_ID = 'B10705039';

SELECT 
    Course.CourseName,
    Course.CourseSch,
    Course.Credits
FROM STUDENT_COURSE
JOIN Course ON STUDENT_COURSE.Course_ID = Course.Course_ID
WHERE STUDENT_COURSE.ICL_ID = 'B10705039' AND STUDENT_COURSE.Semester = '1112';

SELECT 
    TRIP.Trip_No,
    TRIP.StartDate,
    TRIP.EndDate,
    SCHOOL.SchCounty AS SchoolCounty,
    SCHOOL.SchName AS SchoolName, 
    TRIP_STUDENT.ShowUp
FROM TRIP
JOIN TRIP_STUDENT ON TRIP.Semester = TRIP_STUDENT.Semester AND TRIP.Trip_No = TRIP_STUDENT.Trip_No
JOIN TRIP_SCHOOL ON TRIP.Semester = TRIP_SCHOOL.Semester AND TRIP.Trip_No = TRIP_SCHOOL.Trip_No
JOIN SCHOOL ON TRIP_SCHOOL.School_ID = SCHOOL.School_ID
WHERE TRIP_STUDENT.ICL_ID = 'B10705039' AND TRIP.Semester = '1111';

SELECT DISTINCT Semester
FROM STUDENT_COURSE
WHERE ICL_ID = 'B10705039';

SELECT DISTINCT GROUP_.Group_ID, SCHOOL.School_ID, SCHOOL.SchName
FROM GROUP_
JOIN SCHOOL ON GROUP_.School_ID = SCHOOL.School_ID
WHERE (GROUP_.LocICL_ID = 'B10705039' OR GROUP_.IntlICL_ID = 'B10705039') AND GROUP_.Semester = '1112';

SELECT 
    CASE 
        WHEN STUDENT.StuType = 'Local' THEN INTL.StuName
        WHEN STUDENT.StuType = 'International' THEN LOCAL.StuName
    END AS PartnerName,
    CASE 
        WHEN STUDENT.StuType = 'Local' THEN INTL.StuNationality
        WHEN STUDENT.StuType = 'International' THEN LOCAL.StuNationality
    END AS PartnerNationality,
    CASE 
        WHEN STUDENT.StuType = 'Local' THEN INTL.StuEmail
        WHEN STUDENT.StuType = 'International' THEN LOCAL.StuEmail
    END AS PartnerEmail
FROM GROUP_
JOIN STUDENT ON (GROUP_.LocICL_ID = STUDENT.ICL_ID OR GROUP_.IntlICL_ID = STUDENT.ICL_ID)
LEFT JOIN STUDENT AS LOCAL ON GROUP_.LocICL_ID = LOCAL.ICL_ID
LEFT JOIN STUDENT AS INTL ON GROUP_.IntlICL_ID = INTL.ICL_ID
WHERE GROUP_.Group_ID = '00000021' AND (STUDENT.ICL_ID = 'B10705039');

SELECT 
    SCHOOL.SchName AS SchoolName,
    SCHOOL.SchAddress AS SchoolAddress,
    SCHOOL.SchCounty AS SchoolCounty,
    CONTACT.ConName AS ContactName,
    CONTACT.ConEmail AS ContactEmail,
    CONTACT.ConPhone AS ContactPhone
FROM GROUP_
JOIN SCHOOL ON GROUP_.School_ID = SCHOOL.School_ID
JOIN SEMESTER_CONTACT ON SCHOOL.School_ID = SEMESTER_CONTACT.School_ID 
    AND GROUP_.Semester = SEMESTER_CONTACT.Semester
JOIN CONTACT_PERSON AS CONTACT ON SEMESTER_CONTACT.School_ID = CONTACT.School_ID 
    AND SEMESTER_CONTACT.ConName = CONTACT.ConName
WHERE GROUP_.Group_ID = '00000021';

SELECT 
    SESSION.Date AS SessionDate,
    GROUP_.StartTime AS StartTime,
    GROUP_.EndTime AS EndTime,
    ATTEND_STATUS.AttendType AS AttendanceType,
    ATTEND_STATUS.Deduction AS DeductionPoints
FROM SESSION
JOIN GROUP_ ON SESSION.Group_ID = GROUP_.Group_ID
JOIN SESSION_ATTENDANCE ON SESSION.Session_ID = SESSION_ATTENDANCE.Session_ID
JOIN ATTEND_STATUS ON SESSION_ATTENDANCE.Attend_No = ATTEND_STATUS.Attend_No
WHERE GROUP_.Group_ID = '00000021' AND SESSION_ATTENDANCE.ICL_ID = 'B10705039';

-- school page

SELECT 
    SchName AS SchoolName,
    SchCounty AS SchoolCounty,
    SchAddress AS SchoolAddress
FROM SCHOOL
WHERE School_ID = '343502';

SELECT DISTINCT Semester
FROM GROUP_
WHERE School_ID ='343502'
ORDER BY Semester;

SELECT 
    CONTACT_PERSON.ConName AS ContactName,
    CONTACT_PERSON.ConEmail AS ContactEmail,
    CONTACT_PERSON.ConPhone AS ContactPhone
FROM CONTACT_PERSON
JOIN SEMESTER_CONTACT ON SEMESTER_CONTACT.School_ID = CONTACT_PERSON.School_ID 
    AND SEMESTER_CONTACT.ConName = CONTACT_PERSON.ConName
WHERE SEMESTER_CONTACT.School_ID ='343502' AND SEMESTER_CONTACT.Semester = '1112';

SELECT 
    TRIP.Trip_No,
    TRIP.StartDate,
    TRIP.EndDate
FROM TRIP
JOIN TRIP_SCHOOL ON TRIP.Semester = TRIP_SCHOOL.Semester AND TRIP.Trip_No = TRIP_SCHOOL.Trip_No
WHERE TRIP_SCHOOL.School_ID = '343502' AND TRIP.Semester = '1112'
ORDER BY TRIP.Trip_No;

SELECT 
    OTHER_SCHOOLS.SchName AS OtherSchoolName,
    OTHER_SCHOOLS.SchCounty AS OtherSchoolCounty
FROM TRIP
JOIN TRIP_SCHOOL ON TRIP.Semester = TRIP_SCHOOL.Semester AND TRIP.Trip_No = TRIP_SCHOOL.Trip_No
LEFT JOIN TRIP_SCHOOL AS OTHER_TS ON TRIP.Trip_No = OTHER_TS.Trip_No AND TRIP.Semester = OTHER_TS.Semester 
    AND OTHER_TS.School_ID != TRIP_SCHOOL.School_ID
LEFT JOIN SCHOOL AS OTHER_SCHOOLS ON OTHER_TS.School_ID = OTHER_SCHOOLS.School_ID
WHERE TRIP_SCHOOL.School_ID = '343502' AND TRIP.Semester = '1112';

SELECT 
    TRIP_STUDENT.Trip_No,
    STUDENT.StuName AS StudentName,
    STUDENT.StuNationality AS StudentNationality
FROM TRIP_STUDENT
JOIN STUDENT ON TRIP_STUDENT.ICL_ID = STUDENT.ICL_ID
JOIN TRIP_SCHOOL ON TRIP_STUDENT.Trip_No = TRIP_SCHOOL.Trip_No 
    AND TRIP_STUDENT.Semester = TRIP_SCHOOL.Semester
WHERE TRIP_SCHOOL.School_ID = '343502' AND TRIP_SCHOOL.Semester = '1112';

SELECT DISTINCT Semester
FROM GROUP_
WHERE School_ID = '343502'
ORDER BY Semester;

SELECT Group_ID
FROM GROUP_
WHERE School_ID = '343502' AND Semester = '1112'
ORDER BY Group_ID;

SELECT 
    LOCAL.StuName AS LocalStudentName,
    LOCAL.StuNationality AS LocalStudentNationality,
    LOCAL.StuType AS LocalStudentType,
    LOCAL.StuPhone AS LocalStudentPhone,
    LOCAL.StuEmail AS LocalStudentEmail,
    INTL.StuName AS IntlStudentName,
    INTL.StuNationality AS IntlStudentNationality,
    INTL.StuType AS IntlStudentType,
    INTL.StuPhone AS IntlStudentPhone,
    INTL.StuEmail AS IntlStudentEmail
FROM GROUP_
LEFT JOIN STUDENT AS LOCAL ON GROUP_.LocICL_ID = LOCAL.ICL_ID
LEFT JOIN STUDENT AS INTL ON GROUP_.IntlICL_ID = INTL.ICL_ID
WHERE GROUP_.Group_ID = '00000021';

SELECT 
    SESSION.Date AS SessionDate,
    GROUP_.StartTime,
    GROUP_.EndTime,
    LOCAL_STATUS.AttendType AS LocalStudentAttendStatus,
    INTL_STATUS.AttendType AS IntlStudentAttendStatus
FROM SESSION
JOIN GROUP_ ON SESSION.Group_ID = GROUP_.Group_ID
LEFT JOIN SESSION_ATTENDANCE AS LOCAL_ATTEND ON SESSION.Session_ID = LOCAL_ATTEND.Session_ID 
    AND GROUP_.LocICL_ID = LOCAL_ATTEND.ICL_ID
LEFT JOIN ATTEND_STATUS AS LOCAL_STATUS ON LOCAL_ATTEND.Attend_No = LOCAL_STATUS.Attend_No
LEFT JOIN SESSION_ATTENDANCE AS INTL_ATTEND ON SESSION.Session_ID = INTL_ATTEND.Session_ID 
    AND GROUP_.IntlICL_ID = INTL_ATTEND.ICL_ID
LEFT JOIN ATTEND_STATUS AS INTL_STATUS ON INTL_ATTEND.Attend_No = INTL_STATUS.Attend_No
WHERE GROUP_.Group_ID = '00000021'
ORDER BY SESSION.Date;

-- admin search trip

SELECT 
    SCHOOL.SchCounty AS SchoolCounty,
    SCHOOL.SchName AS SchoolName, 
    SCHOOL.SchAddress AS SchoolAddress,
    CONTACT_PERSON.ConName AS ContactName,
    CONTACT_PERSON.ConEmail AS ContactEmail,
    CONTACT_PERSON.ConPhone AS ContactPhone 
FROM TRIP 
JOIN TRIP_SCHOOL ON TRIP.Semester = TRIP_SCHOOL.Semester AND TRIP.Trip_No = TRIP_SCHOOL.Trip_No 
JOIN SCHOOL ON TRIP_SCHOOL.School_ID = SCHOOL.School_ID 
JOIN SEMESTER_CONTACT ON SCHOOL.School_ID = SEMESTER_CONTACT.School_ID 
    AND TRIP.Semester = SEMESTER_CONTACT.Semester 
JOIN CONTACT_PERSON ON SEMESTER_CONTACT.ConName = CONTACT_PERSON.ConName 
    AND SEMESTER_CONTACT.School_ID = CONTACT_PERSON.School_ID
WHERE TRIP.Semester = '1112' AND TRIP.Trip_No = 35;

SELECT 
    ST.ICL_ID, 
    ST.StuName, 
    ROUND(
        (COUNT(CASE WHEN SA.Attend_No = 'A' THEN 1 ELSE NULL END) * 100.0) /
        NULLIF(COUNT(CASE WHEN SA.Attend_No != 'J' THEN 1 ELSE NULL END), 0),
        2
    ) AS AttendanceRate
FROM STUDENT ST
JOIN SESSION_ATTENDANCE SA ON ST.ICL_ID = SA.ICL_ID
JOIN SESSION S ON SA.Session_ID = S.Session_ID
JOIN GROUP_ G ON S.Group_ID = G.Group_ID
WHERE G.Semester = '1112'
GROUP BY ST.ICL_ID, ST.StuName
ORDER BY AttendanceRate ASC
LIMIT 10;

SELECT 
    TRIP.Trip_No,
    COUNT(*) AS TotalStudents,
    SUM(CASE WHEN TRIP_STUDENT.ShowUp = 'F' THEN 1 ELSE 0 END) AS NoShowCount,
    (SUM(CASE WHEN TRIP_STUDENT.ShowUp = 'F' THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) AS NoShowRate
FROM TRIP
JOIN TRIP_STUDENT ON TRIP.Semester = TRIP_STUDENT.Semester AND TRIP.Trip_No = TRIP_STUDENT.Trip_No
WHERE TRIP.Semester ='1112'
GROUP BY TRIP.Trip_No
ORDER BY NoShowRate DESC
LIMIT 10;